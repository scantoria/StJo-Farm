<div class="animal-admin-container">
  <h1>Manage Animal of the Month</h1>

  <!-- Form Section -->
  <mat-card class="form-card">
    <mat-card-header>
      <mat-card-title>
        {{ isEditing() ? 'Edit Animal' : 'Add New Animal' }}
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="animalForm" (ngSubmit)="onSubmit()">
        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Animal Name</mat-label>
            <input matInput formControlName="name" placeholder="e.g., Millie">
            @if (animalForm.get('name')?.hasError('required')) {
              <mat-error>Name is required</mat-error>
            }
          </mat-form-field>
        </div>

        <div class="form-row">
          <div class="image-upload-section">
            <h3>Animal Image</h3>

            <!-- File Upload -->
            <div class="upload-area">
              <input
                type="file"
                #fileInput
                (change)="onFileSelected($event)"
                accept="image/*"
                style="display: none">

              <button
                mat-raised-button
                type="button"
                (click)="fileInput.click()"
                [disabled]="loading() || uploading()">
                <mat-icon>upload</mat-icon>
                Upload New Image
              </button>

              @if (uploading()) {
                <mat-progress-bar mode="indeterminate"></mat-progress-bar>
                <p class="upload-status">Uploading image...</p>
              }
            </div>

            <!-- Image Preview -->
            @if (previewUrl() || animalForm.get('imageUrl')?.value) {
              <div class="image-preview">
                <img
                  [src]="previewUrl() || animalForm.get('imageUrl')?.value"
                  alt="Preview"
                  class="preview-image">
                @if (selectedFile()) {
                  <button
                    mat-icon-button
                    type="button"
                    (click)="clearSelectedImage()"
                    class="clear-image-btn">
                    <mat-icon>close</mat-icon>
                  </button>
                }
              </div>
            }

            <!-- OR Manual URL Entry -->
            <div class="url-option">
              <p class="divider-text">OR enter image URL manually</p>
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Image URL</mat-label>
                <input matInput formControlName="imageUrl" placeholder="e.g., dairy-cow-millie-2.jpg">
                <mat-hint>Enter filename from assets or full URL</mat-hint>
                @if (animalForm.get('imageUrl')?.hasError('required')) {
                  <mat-error>Image URL is required</mat-error>
                }
              </mat-form-field>
            </div>
          </div>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Description</mat-label>
            <textarea
              matInput
              formControlName="description"
              rows="5"
              placeholder="Tell us about this animal..."></textarea>
            <mat-hint>Minimum 50 characters</mat-hint>
            @if (animalForm.get('description')?.hasError('required')) {
              <mat-error>Description is required</mat-error>
            }
            @if (animalForm.get('description')?.hasError('minlength')) {
              <mat-error>Description must be at least 50 characters</mat-error>
            }
          </mat-form-field>
        </div>

        <div class="form-row two-columns">
          <mat-form-field appearance="outline">
            <mat-label>Month</mat-label>
            <input matInput formControlName="month" placeholder="e.g., November">
            @if (animalForm.get('month')?.hasError('required')) {
              <mat-error>Month is required</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Year</mat-label>
            <input matInput type="number" formControlName="year" placeholder="2025">
            @if (animalForm.get('year')?.hasError('required')) {
              <mat-error>Year is required</mat-error>
            }
            @if (animalForm.get('year')?.hasError('min')) {
              <mat-error>Year must be 2020 or later</mat-error>
            }
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-slide-toggle formControlName="isActive">
            Set as Active Animal of the Month
          </mat-slide-toggle>
        </div>

        <div class="form-actions">
          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="loading() || animalForm.invalid">
            @if (loading()) {
              Saving...
            } @else {
              {{ isEditing() ? 'Update Animal' : 'Add Animal' }}
            }
          </button>

          @if (isEditing()) {
            <button
              mat-button
              type="button"
              (click)="cancelEdit()"
              [disabled]="loading()">
              Cancel
            </button>
          }
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- List Section -->
  <mat-card class="list-card">
    <mat-card-header>
      <mat-card-title>All Animals</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      @if (loading()) {
        <div class="loading">Loading animals...</div>
      } @else if (animals().length === 0) {
        <div class="no-data">
          <p>No animals added yet. Add your first animal above!</p>
        </div>
      } @else {
        <table mat-table [dataSource]="animals()" class="animals-table">
          <!-- Name Column -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef>Name</th>
            <td mat-cell *matCellDef="let animal">{{ animal.name }}</td>
          </ng-container>

          <!-- Month Column -->
          <ng-container matColumnDef="month">
            <th mat-header-cell *matHeaderCellDef>Month</th>
            <td mat-cell *matCellDef="let animal">{{ animal.month }}</td>
          </ng-container>

          <!-- Year Column -->
          <ng-container matColumnDef="year">
            <th mat-header-cell *matHeaderCellDef>Year</th>
            <td mat-cell *matCellDef="let animal">{{ animal.year }}</td>
          </ng-container>

          <!-- Active Column -->
          <ng-container matColumnDef="isActive">
            <th mat-header-cell *matHeaderCellDef>Active</th>
            <td mat-cell *matCellDef="let animal">
              @if (animal.isActive) {
                <span class="active-badge">Active</span>
              } @else {
                <button
                  mat-button
                  color="accent"
                  (click)="setActive(animal)"
                  [disabled]="loading()">
                  Set Active
                </button>
              }
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let animal">
              <button
                mat-icon-button
                color="primary"
                (click)="editAnimal(animal)"
                [disabled]="loading()"
                matTooltip="Edit">
                <mat-icon>edit</mat-icon>
              </button>
              <button
                mat-icon-button
                color="warn"
                (click)="deleteAnimal(animal)"
                [disabled]="loading()"
                matTooltip="Delete">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      }
    </mat-card-content>
  </mat-card>
</div>
